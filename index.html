<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super PDF Tools Web</title>
    
    <!-- Estilos CSS -->
    <style>
        :root { --primary: #e53e3e; --bg: #f7f9fc; --text: #2d3748; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        /* Header */
        header { background: white; padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: center; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        
        /* Grid Layout */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        
        /* Tarjetas */
        .card {
            background: white; padding: 2rem; border-radius: 12px; cursor: pointer;
            transition: all 0.2s; border: 1px solid #e2e8f0; display: flex; flex-direction: column;
            align-items: center; text-align: center; height: 100%;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-color: var(--primary); }
        .icon { font-size: 3rem; margin-bottom: 1rem; }
        .card h3 { margin: 0.5rem 0; font-size: 1.1rem; color: #1a202c; }
        .card p { font-size: 0.85rem; color: #718096; line-height: 1.4; }

        /* Vistas de Herramientas */
        .tool-panel { display: none; background: white; padding: 3rem; border-radius: 16px; max-width: 600px; margin: 2rem auto; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .active-view { display: block; }

        /* Inputs y Botones */
        .btn-back { background: transparent; border: none; color: #718096; cursor: pointer; margin-bottom: 1rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-back:hover { color: var(--primary); }
        
        .btn-action {
            background-color: var(--primary); color: white; width: 100%; padding: 1rem;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: bold;
            cursor: pointer; margin-top: 1.5rem; transition: background 0.2s;
        }
        .btn-action:hover { background-color: #c53030; }
        .btn-action:disabled { background-color: #cbd5e0; cursor: not-allowed; }

        input[type="file"] { margin: 1rem 0; padding: 0.5rem; border: 2px dashed #cbd5e0; border-radius: 8px; width: 100%; box-sizing: border-box; }
        input[type="text"], input[type="password"] { width: 100%; padding: 0.8rem; margin: 0.5rem 0; border: 1px solid #cbd5e0; border-radius: 6px; box-sizing: border-box; }
        
        .status { margin-top: 1rem; font-weight: 600; min-height: 1.5rem; }
        .text-green { color: #2f855a; }
        .text-red { color: #c53030; }
        .info-text { font-size: 0.8rem; color: #718096; margin-bottom: 1rem; }
    </style>

    <!-- LIBRER√çAS (Todas cargadas desde CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7/download.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

    <header>
        <div class="logo" onclick="goHome()">üõ†Ô∏è PDF Tools Ultimate</div>
    </header>

    <div class="container">
        <!-- MEN√ö DE OPCIONES -->
        <div id="menu-grid" class="grid">
            
            <div class="card" onclick="loadTool('merge')">
                <div class="icon">üîó</div><h3>Unir PDF</h3><p>Combina varios archivos en uno solo.</p>
            </div>

            <div class="card" onclick="loadTool('split')">
                <div class="icon">‚úÇÔ∏è</div><h3>Dividir PDF</h3><p>Extrae todas las p√°ginas como archivos sueltos (ZIP).</p>
            </div>

            <div class="card" onclick="loadTool('delete')">
                <div class="icon">üóëÔ∏è</div><h3>Eliminar P√°ginas</h3><p>Borra p√°ginas espec√≠ficas de tu documento.</p>
            </div>

            <div class="card" onclick="loadTool('excel')">
                <div class="icon">üìä</div><h3>PDF a Excel</h3><p>Convierte tablas y listas a .xlsx.</p>
            </div>

            <div class="card" onclick="loadTool('rotate')">
                <div class="icon">üîÑ</div><h3>Rotar PDF</h3><p>Gira tus documentos 90 grados.</p>
            </div>

            <div class="card" onclick="loadTool('jpg2pdf')">
                <div class="icon">üñºÔ∏è</div><h3>JPG a PDF</h3><p>Convierte tus fotos en un documento PDF.</p>
            </div>

            <div class="card" onclick="loadTool('pdf2jpg')">
                <div class="icon">üì∏</div><h3>PDF a JPG</h3><p>Convierte p√°ginas de PDF a im√°genes.</p>
            </div>

            <div class="card" onclick="loadTool('watermark')">
                <div class="icon">üíß</div><h3>Marca de Agua</h3><p>A√±ade texto sobre tus p√°ginas.</p>
            </div>

            <div class="card" onclick="loadTool('number')">
                <div class="icon">üî¢</div><h3>Numerar P√°ginas</h3><p>A√±ade n√∫meros al pie de p√°gina.</p>
            </div>

            <div class="card" onclick="loadTool('protect')">
                <div class="icon">üîí</div><h3>Proteger PDF</h3><p>A√±ade una contrase√±a a tu archivo.</p>
            </div>

        </div>

        <!-- PANELES DE HERRAMIENTAS (Se generan din√°micamente o se muestran) -->
        
        <!-- GENERIC TOOL CONTAINER -->
        <div id="tool-container" class="tool-panel">
            <button class="btn-back" onclick="goHome()">‚¨Ö Volver al men√∫</button>
            <h2 id="tool-title">Herramienta</h2>
            <p id="tool-desc" class="info-text"></p>
            
            <div id="tool-inputs"></div>
            
            <button id="btn-process" class="btn-action">Procesar</button>
            <div id="status-msg" class="status"></div>
        </div>

    </div>

<script>
    // --- CONFIGURACI√ìN GLOBAL ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;

    const UI = {
        menu: document.getElementById('menu-grid'),
        panel: document.getElementById('tool-container'),
        title: document.getElementById('tool-title'),
        desc: document.getElementById('tool-desc'),
        inputs: document.getElementById('tool-inputs'),
        btn: document.getElementById('btn-process'),
        status: document.getElementById('status-msg')
    };

    let currentTool = null;

    // --- NAVEGACI√ìN ---
    function goHome() {
        UI.panel.style.display = 'none';
        UI.menu.style.display = 'grid';
        UI.inputs.innerHTML = '';
        UI.status.textContent = '';
        UI.btn.disabled = false;
        UI.btn.textContent = 'Procesar';
    }

    function loadTool(tool) {
        currentTool = tool;
        UI.menu.style.display = 'none';
        UI.panel.style.display = 'block';
        UI.status.textContent = '';
        UI.btn.onclick = executeTool;
        UI.btn.textContent = "Ejecutar";
        
        // Configurar UI seg√∫n la herramienta
        let html = '';
        if(tool === 'merge') {
            UI.title.textContent = "Unir PDFs";
            UI.desc.textContent = "Selecciona varios archivos (mant√©n Ctrl pulsado)";
            html = '<input type="file" id="file-in" accept="application/pdf" multiple>';
        } 
        else if(tool === 'split') {
            UI.title.textContent = "Dividir PDF";
            UI.desc.textContent = "Se descargar√° un archivo ZIP con cada p√°gina por separado.";
            html = '<input type="file" id="file-in" accept="application/pdf">';
        }
        else if(tool === 'delete') {
            UI.title.textContent = "Eliminar P√°ginas";
            UI.desc.textContent = "Ejemplo: 1,3,5 (Borrar√° la p√°gina 1, la 3 y la 5)";
            html = '<input type="file" id="file-in" accept="application/pdf"><input type="text" id="extra-in" placeholder="P√°ginas a borrar (ej: 1,2)">';
        }
        else if(tool === 'excel') {
            UI.title.textContent = "PDF a Excel";
            html = '<input type="file" id="file-in" accept="application/pdf">';
        }
        else if(tool === 'rotate') {
            UI.title.textContent = "Rotar PDF";
            html = '<input type="file" id="file-in" accept="application/pdf">';
        }
        else if(tool === 'jpg2pdf') {
            UI.title.textContent = "JPG a PDF";
            UI.desc.textContent = "Selecciona varias im√°genes.";
            html = '<input type="file" id="file-in" accept="image/jpeg, image/png" multiple>';
        }
        else if(tool === 'pdf2jpg') {
            UI.title.textContent = "PDF a JPG";
            UI.desc.textContent = "Convierte p√°ginas a im√°genes (Descarga ZIP).";
            html = '<input type="file" id="file-in" accept="application/pdf">';
        }
        else if(tool === 'watermark') {
            UI.title.textContent = "Marca de Agua";
            html = '<input type="file" id="file-in" accept="application/pdf"><input type="text" id="extra-in" placeholder="Texto de la marca (ej: CONFIDENCIAL)">';
        }
        else if(tool === 'number') {
            UI.title.textContent = "Numerar P√°ginas";
            html = '<input type="file" id="file-in" accept="application/pdf">';
        }
        else if(tool === 'protect') {
            UI.title.textContent = "Proteger con Contrase√±a";
            html = '<input type="file" id="file-in" accept="application/pdf"><input type="password" id="extra-in" placeholder="Escribe la contrase√±a">';
        }

        UI.inputs.innerHTML = html;
    }

    // --- EJECUCI√ìN CENTRAL ---
    async function executeTool() {
        const fileInput = document.getElementById('file-in');
        if (!fileInput.files.length) {
            UI.status.textContent = "‚ùå Por favor selecciona un archivo.";
            UI.status.className = "status text-red";
            return;
        }

        UI.btn.disabled = true;
        UI.btn.textContent = "Procesando...";
        UI.status.textContent = "‚è≥ Trabajando en ello...";
        UI.status.className = "status";

        try {
            if (currentTool === 'merge') await processMerge(fileInput.files);
            else if (currentTool === 'split') await processSplit(fileInput.files[0]);
            else if (currentTool === 'delete') await processDelete(fileInput.files[0]);
            else if (currentTool === 'excel') await processExcel(fileInput.files[0]);
            else if (currentTool === 'rotate') await processRotate(fileInput.files[0]);
            else if (currentTool === 'jpg2pdf') await processJpgToPdf(fileInput.files);
            else if (currentTool === 'pdf2jpg') await processPdfToJpg(fileInput.files[0]);
            else if (currentTool === 'watermark') await processWatermark(fileInput.files[0]);
            else if (currentTool === 'number') await processNumber(fileInput.files[0]);
            else if (currentTool === 'protect') await processProtect(fileInput.files[0]);
            
            UI.status.textContent = "‚úÖ ¬°Operaci√≥n completada con √©xito!";
            UI.status.className = "status text-green";
        } catch (error) {
            console.error(error);
            UI.status.textContent = "‚ùå Error: " + error.message;
            UI.status.className = "status text-red";
        } finally {
            UI.btn.disabled = false;
            UI.btn.textContent = "Ejecutar de nuevo";
        }
    }

    // --- FUNCIONES ESPEC√çFICAS ---

    // 1. UNIR PDF
    async function processMerge(files) {
        if(files.length < 2) throw new Error("Necesitas al menos 2 archivos.");
        const mergedPdf = await PDFDocument.create();
        for (let file of files) {
            const ab = await file.arrayBuffer();
            const pdf = await PDFDocument.load(ab);
            const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
            copiedPages.forEach((page) => mergedPdf.addPage(page));
        }
        const pdfBytes = await mergedPdf.save();
        download(pdfBytes, "unido.pdf", "application/pdf");
    }

    // 2. DIVIDIR PDF (ZIP)
    async function processSplit(file) {
        const ab = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(ab);
        const zip = new JSZip();
        
        for (let i = 0; i < pdfDoc.getPageCount(); i++) {
            const subDoc = await PDFDocument.create();
            const [copiedPage] = await subDoc.copyPages(pdfDoc, [i]);
            subDoc.addPage(copiedPage);
            const pdfBytes = await subDoc.save();
            zip.file(`pagina_${i+1}.pdf`, pdfBytes);
        }
        
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, "paginas_separadas.zip");
    }

    // 3. ELIMINAR P√ÅGINAS
    async function processDelete(file) {
        const pagesStr = document.getElementById('extra-in').value;
        if(!pagesStr) throw new Error("Indica qu√© p√°ginas borrar.");
        
        // Convertir "1, 3" a array de √≠ndices [0, 2]
        const pagesToDelete = pagesStr.split(',').map(n => parseInt(n.trim()) - 1);
        
        const ab = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(ab);
        const newPdf = await PDFDocument.create();
        const totalPages = pdfDoc.getPageCount();

        // Copiar solo las que NO est√°n en la lista de borrar
        const pagesToKeep = [];
        for(let i=0; i<totalPages; i++) {
            if(!pagesToDelete.includes(i)) pagesToKeep.push(i);
        }
        
        if(pagesToKeep.length === 0) throw new Error("No puedes borrar todas las p√°ginas.");

        const copiedPages = await newPdf.copyPages(pdfDoc, pagesToKeep);
        copiedPages.forEach(p => newPdf.addPage(p));
        
        const pdfBytes = await newPdf.save();
        download(pdfBytes, "paginas_borradas.pdf", "application/pdf");
    }

    // 4. PDF A EXCEL (Tu c√≥digo original mejorado)
    async function processExcel(file) {
        const ab = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(ab).promise;
        let fullData = [];

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            let items = text.items.map(it => ({ str: it.str, y: it.transform[5], x: it.transform[4] }));
            items.sort((a,b) => (b.y - a.y) || (a.x - b.x));
            
            let row = [], lastY = -999;
            items.forEach(it => {
                if (lastY !== -999 && Math.abs(it.y - lastY) > 8) {
                    fullData.push(row); row = [];
                }
                row.push(it.str);
                lastY = it.y;
            });
            if(row.length) fullData.push(row);
        }
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(fullData);
        XLSX.utils.book_append_sheet(wb, ws, "Datos");
        XLSX.writeFile(wb, "convertido.xlsx");
    }

    // 5. ROTAR PDF
    async function processRotate(file) {
        const ab = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(ab);
        const pages = pdfDoc.getPages();
        pages.forEach(p => p.setRotation(degrees(p.getRotation().angle + 90)));
        const pdfBytes = await pdfDoc.save();
        download(pdfBytes, "rotado.pdf", "application/pdf");
    }

    // 6. JPG A PDF
    async function processJpgToPdf(files) {
        const pdfDoc = await PDFDocument.create();
        for (let file of files) {
            const ab = await file.arrayBuffer();
            let image;
            if (file.type === 'image/jpeg') image = await pdfDoc.embedJpg(ab);
            else if (file.type === 'image/png') image = await pdfDoc.embedPng(ab);
            else continue;

            const page = pdfDoc.addPage([image.width, image.height]);
            page.drawImage(image, { x: 0, y: 0, width: image.width, height: image.height });
        }
        const pdfBytes = await pdfDoc.save();
        download(pdfBytes, "imagenes.pdf", "application/pdf");
    }

    // 7. PDF A JPG (ZIP)
    async function processPdfToJpg(file) {
        const ab = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(ab).promise;
        const zip = new JSZip();

        for(let i=1; i<=pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({scale: 2.0}); // Calidad alta
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({canvasContext: ctx, viewport: viewport}).promise;
            
            // Convertir canvas a blob
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
            zip.file(`pagina_${i}.jpg`, blob);
        }

        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, "pdf_a_imagenes.zip");
    }

    // 8. MARCA DE AGUA
    async function processWatermark(file) {
        const text = document.getElementById('extra-in').value || "CONFIDENCIAL";
        const ab = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(ab);
        const pages = pdfDoc.getPages();
        
        pages.forEach(page => {
            const { width, height } = page.getSize();
            page.drawText(text, {
                x: 50,
                y: height / 2,
                size: 50,
                color: rgb(0.95, 0.1, 0.1),
                opacity: 0.3,
                rotate: degrees(45),
            });
        });
        
        const pdfBytes = await pdfDoc.save();
        download(pdfBytes, "marca_agua.pdf", "application/pdf");
    }

    // 9. NUMERAR P√ÅGINAS
    async function processNumber(file) {
        const ab = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(ab);
        const pages = pdfDoc.getPages();
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        
        for (let i = 0; i < pages.length; i++) {
            const page = pages[i];
            const { width } = page.getSize();
            page.drawText(`${i + 1}`, {
                x: width / 2,
                y: 20,
                size: 12,
                font: font,
                color: rgb(0, 0, 0),
            });
        }
        
        const pdfBytes = await pdfDoc.save();
        download(pdfBytes, "numerado.pdf", "application/pdf");
    }

    // 10. PROTEGER
    async function processProtect(file) {
        const password = document.getElementById('extra-in').value;
        if(!password) throw new Error("Escribe una contrase√±a.");

        const ab = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(ab);
        const pdfBytes = await pdfDoc.save({
            userPassword: password,
            ownerPassword: password
        });
        download(pdfBytes, "protegido.pdf", "application/pdf");
    }

</script>

</body>
</html>
