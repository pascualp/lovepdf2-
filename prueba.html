<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor PDF a Excel Web</title>
    <!-- Estilo moderno y limpio -->
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 480px;
            text-align: center;
        }
        h1 { color: #1f2937; margin-bottom: 0.5rem; font-size: 1.5rem; }
        p { color: #6b7280; margin-bottom: 1.5rem; font-size: 0.9rem; }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            padding: 2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9fafb;
        }
        .upload-area:hover, .upload-area.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .icon { font-size: 3rem; margin-bottom: 0.5rem; display: block; }
        
        button {
            background-color: #10b981;
            color: white;
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background-color: #059669; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        #status { margin-top: 1rem; font-size: 0.875rem; color: #4b5563; min-height: 1.5rem;}
        .hidden { display: none; }
    </style>

    <!-- Librer√≠as desde CDN (Funcionan perfecto en GitHub Pages) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Conversor PDF a Excel</h1>
    <p>Sube tu archivo y desc√°rgalo en formato .xlsx</p>

    <label class="upload-area" id="drop-zone">
        <span class="icon">üìÑ</span>
        <span id="file-label">Haz clic o arrastra tu PDF aqu√≠</span>
        <input type="file" id="pdf-upload" accept="application/pdf" class="hidden">
    </label>

    <div id="status"></div>

    <button id="convert-btn" disabled>Descargar Excel</button>
</div>

<script>
    // Configurar el Worker correctamente para entorno Web
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('pdf-upload');
    const convertBtn = document.getElementById('convert-btn');
    const statusText = document.getElementById('status');
    const fileLabel = document.getElementById('file-label');
    let currentFile = null;

    // --- Manejo de Drag & Drop ---
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('active'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('active'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        handleFile(e.dataTransfer.files[0]);
    });
    fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

    function handleFile(file) {
        if (!file || file.type !== 'application/pdf') {
            statusText.textContent = "‚ùå Por favor, sube un archivo PDF v√°lido.";
            statusText.style.color = "red";
            return;
        }
        currentFile = file;
        fileLabel.textContent = "‚úÖ " + file.name;
        statusText.textContent = "Archivo listo para convertir.";
        statusText.style.color = "#4b5563";
        convertBtn.disabled = false;
    }

    // --- L√≥gica de Conversi√≥n ---
    convertBtn.addEventListener('click', async () => {
        if (!currentFile) return;

        convertBtn.disabled = true;
        convertBtn.textContent = "Procesando...";
        statusText.textContent = "‚è≥ Leyendo documento...";

        try {
            const arrayBuffer = await currentFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            let allRows = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                statusText.textContent = `‚è≥ Analizando p√°gina ${i} de ${pdf.numPages}...`;
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                // Extraer items y coordenadas
                let items = textContent.items.map(item => ({
                    str: item.str,
                    x: item.transform[4], // Posici√≥n Horizontal
                    y: item.transform[5]  // Posici√≥n Vertical
                }));

                // Si no hay items, probablemente sea imagen
                if (items.length === 0 && i === 1) {
                    throw new Error("El PDF parece ser una imagen escaneada sin texto seleccionable.");
                }

                // Ordenar: Arriba a abajo (Y desc), Izquierda a derecha (X asc)
                items.sort((a, b) => (b.y - a.y) || (a.x - b.x));

                // Algoritmo de agrupaci√≥n por filas
                let currentRow = [];
                let lastY = -9999;
                
                items.forEach(item => {
                    // Si est√° en la misma l√≠nea (tolerancia 5px)
                    if (lastY === -9999 || Math.abs(item.y - lastY) < 5) {
                        currentRow.push(item.str);
                    } else {
                        // Nueva l√≠nea detectada
                        allRows.push(currentRow);
                        currentRow = [item.str];
                    }
                    lastY = item.y;
                });
                if (currentRow.length > 0) allRows.push(currentRow);
            }

            // Crear Excel
            statusText.textContent = "üìä Generando archivo...";
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(allRows);
            
            // Ajustar ancho de columnas b√°sico
            if (allRows.length > 0) {
                ws['!cols'] = allRows[0].map(() => ({ wch: 20 }));
            }

            XLSX.utils.book_append_sheet(wb, ws, "Datos Extra√≠dos");
            
            // Descargar
            XLSX.writeFile(wb, currentFile.name.replace('.pdf', '') + "_Excel.xlsx");

            statusText.textContent = "‚úÖ ¬°Conversi√≥n completada!";
            statusText.style.color = "green";
            convertBtn.textContent = "Convertir otro archivo";
            convertBtn.disabled = false;
            
            // Reiniciar tras 3 segundos
            setTimeout(() => {
                currentFile = null;
                fileLabel.textContent = "Haz clic o arrastra tu PDF aqu√≠";
            }, 5000);

        } catch (error) {
            console.error(error);
            statusText.textContent = "‚ùå Error: " + error.message;
            statusText.style.color = "red";
            convertBtn.textContent = "Reintentar";
            convertBtn.disabled = false;
        }
    });
</script>

</body>
</html>