<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor PDF a Excel (Chrome Local)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; text-align: center; }
        .box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        .drop-area { border: 2px dashed #007bff; padding: 30px; border-radius: 5px; background: #eef7ff; cursor: pointer; margin-bottom: 20px; }
        button { background: #28a745; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; width: 100%; }
        button:disabled { background: #ccc; }
        #log { margin-top: 15px; font-size: 12px; color: #333; text-align: left; background: #eee; padding: 10px; height: 100px; overflow: auto; border-radius: 5px; }
    </style>
    
    <!-- Usamos scripts s√≠ncronos para evitar bloqueos de seguridad en local -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
</head>
<body>

<div class="box">
    <h2>Conversor para Chrome</h2>
    <div class="drop-area" id="drop-zone">
        üìÇ Arrastra tu PDF aqu√≠
        <input type="file" id="file-in" accept="application/pdf" style="display:none">
    </div>
    <button id="btn" disabled>Esperando archivo...</button>
    <div id="log">Logs del sistema...</div>
</div>

<script>
    // IMPORTANTE: Desactivar Workers para que Chrome no bloquee el archivo local
    pdfjsLib.GlobalWorkerOptions.workerSrc = ''; 

    const dropZone = document.getElementById('drop-zone');
    const fileIn = document.getElementById('file-in');
    const btn = document.getElementById('btn');
    const logDiv = document.getElementById('log');
    let currentFile = null;

    function log(m) { logDiv.innerHTML += `<div>> ${m}</div>`; logDiv.scrollTop = logDiv.scrollHeight; }

    dropZone.onclick = () => fileIn.click();
    fileIn.onchange = (e) => handleFile(e.target.files[0]);
    
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = '#dbeeff'; };
    dropZone.ondragleave = () => dropZone.style.background = '#eef7ff';
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.style.background = '#eef7ff';
        handleFile(e.dataTransfer.files[0]);
    };

    function handleFile(f) {
        if (!f || f.type !== 'application/pdf') return alert("Solo PDF");
        currentFile = f;
        btn.innerText = "Convertir " + f.name;
        btn.disabled = false;
        btn.onclick = process;
        log("Archivo cargado: " + f.name);
    }

    async function process() {
        btn.disabled = true;
        btn.innerText = "Procesando... (Espera)";
        log("Leyendo PDF...");

        try {
            const buffer = await currentFile.arrayBuffer();
            
            // Carga SIN worker externo
            const loadingTask = pdfjsLib.getDocument(buffer);
            const pdf = await loadingTask.promise;
            
            log(`P√°ginas encontradas: ${pdf.numPages}`);
            let data = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                log(`Leyendo p√°g ${i}...`);
                const page = await pdf.getPage(i);
                const text = await page.getTextContent();
                
                // Procesar texto
                let items = text.items.map(it => ({ str: it.str, y: it.transform[5], x: it.transform[4] }));
                items.sort((a,b) => (b.y - a.y) || (a.x - b.x));

                let row = [], lastY = -999;
                items.forEach(it => {
                    if (lastY !== -999 && Math.abs(it.y - lastY) > 8) {
                        data.push(row); row = [];
                    }
                    row.push(it.str);
                    lastY = it.y;
                });
                if(row.length) data.push(row);
            }

            log("Creando Excel...");
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Hoja1");
            XLSX.writeFile(wb, "Resultado.xlsx");
            
            log("‚úÖ ¬°Descargado!");
            btn.innerText = "Convertir otro";
            btn.disabled = false;

        } catch (e) {
            log("‚ùå Error: " + e.message);
            console.error(e);
            alert("Error: " + e.message);
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
